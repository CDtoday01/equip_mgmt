{"ast":null,"code":"// src/api.js\nimport axios from \"axios\";\nconst api = axios.create({\n  baseURL: \"http://127.0.0.1:8000/api/\"\n});\n\n// ====== Token 相關 ======\nconst getAccessToken = () => localStorage.getItem(\"access_token\");\nconst getRefreshToken = () => localStorage.getItem(\"refresh_token\");\nconst saveTokens = (access, refresh) => {\n  localStorage.setItem(\"access_token\", access);\n  if (refresh) localStorage.setItem(\"refresh_token\", refresh);\n};\nconst clearTokens = () => {\n  localStorage.removeItem(\"access_token\");\n  localStorage.removeItem(\"refresh_token\");\n};\n\n// ====== 主動檢查 token 是否快過期 ======\nconst isTokenExpiringSoon = token => {\n  if (!token) return true;\n  try {\n    const payload = JSON.parse(atob(token.split(\".\")[1]));\n    const exp = payload.exp * 1000;\n    return exp - Date.now() < 60 * 1000; // 少於60秒視為快過期\n  } catch {\n    return true;\n  }\n};\n\n// ====== 重新刷新 access token ======\nasync function refreshAccessToken() {\n  const refresh = getRefreshToken();\n  if (!refresh) throw new Error(\"No refresh token\");\n  const response = await axios.post(\"http://127.0.0.1:8000/api/users/refresh/\", {\n    refresh\n  });\n  const newAccess = response.data.access;\n  saveTokens(newAccess, refresh);\n  return newAccess;\n}\n\n// ====== 攔截器設定 ======\napi.interceptors.request.use(async config => {\n  const url = config.url || \"\";\n\n  // 不對登入或刷新 API 附加 token\n  if (url.includes(\"users/login\") || url.includes(\"users/token/refresh\")) {\n    return config;\n  }\n  let token = getAccessToken();\n\n  // 主動刷新\n  if (isTokenExpiringSoon(token)) {\n    try {\n      token = await refreshAccessToken();\n    } catch (err) {\n      clearTokens();\n      window.location.href = \"/login\";\n      throw err;\n    }\n  }\n  if (token) {\n    config.headers.Authorization = `Bearer ${token}`;\n  }\n  return config;\n});\n\n// 被動刷新\napi.interceptors.response.use(response => response, async error => {\n  var _error$response;\n  const originalRequest = error.config;\n  const status = (_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.status;\n\n  // 若 access token 過期 → 試著 refresh\n  if (status === 401 && !originalRequest._retry) {\n    originalRequest._retry = true;\n    try {\n      const newAccess = await refreshAccessToken();\n      api.defaults.headers.common[\"Authorization\"] = `Bearer ${newAccess}`;\n      originalRequest.headers[\"Authorization\"] = `Bearer ${newAccess}`;\n      return api(originalRequest);\n    } catch {\n      clearTokens();\n      window.location.href = \"/login\";\n    }\n  }\n  return Promise.reject(error);\n});\nexport default api;","map":{"version":3,"names":["axios","api","create","baseURL","getAccessToken","localStorage","getItem","getRefreshToken","saveTokens","access","refresh","setItem","clearTokens","removeItem","isTokenExpiringSoon","token","payload","JSON","parse","atob","split","exp","Date","now","refreshAccessToken","Error","response","post","newAccess","data","interceptors","request","use","config","url","includes","err","window","location","href","headers","Authorization","error","_error$response","originalRequest","status","_retry","defaults","common","Promise","reject"],"sources":["C:/Users/lsps_/OneDrive/Documents/equip_mgmt/equip-frontend/src/api.js"],"sourcesContent":["// src/api.js\r\nimport axios from \"axios\";\r\n\r\nconst api = axios.create({\r\n  baseURL: \"http://127.0.0.1:8000/api/\",\r\n});\r\n\r\n// ====== Token 相關 ======\r\nconst getAccessToken = () => localStorage.getItem(\"access_token\");\r\nconst getRefreshToken = () => localStorage.getItem(\"refresh_token\");\r\n\r\nconst saveTokens = (access, refresh) => {\r\n  localStorage.setItem(\"access_token\", access);\r\n  if (refresh) localStorage.setItem(\"refresh_token\", refresh);\r\n};\r\n\r\nconst clearTokens = () => {\r\n  localStorage.removeItem(\"access_token\");\r\n  localStorage.removeItem(\"refresh_token\");\r\n};\r\n\r\n// ====== 主動檢查 token 是否快過期 ======\r\nconst isTokenExpiringSoon = (token) => {\r\n  if (!token) return true;\r\n  try {\r\n    const payload = JSON.parse(atob(token.split(\".\")[1]));\r\n    const exp = payload.exp * 1000;\r\n    return exp - Date.now() < 60 * 1000; // 少於60秒視為快過期\r\n  } catch {\r\n    return true;\r\n  }\r\n};\r\n\r\n// ====== 重新刷新 access token ======\r\nasync function refreshAccessToken() {\r\n  const refresh = getRefreshToken();\r\n  if (!refresh) throw new Error(\"No refresh token\");\r\n\r\n  const response = await axios.post(\"http://127.0.0.1:8000/api/users/refresh/\", {\r\n    refresh,\r\n  });\r\n\r\n  const newAccess = response.data.access;\r\n  saveTokens(newAccess, refresh);\r\n  return newAccess;\r\n}\r\n\r\n// ====== 攔截器設定 ======\r\napi.interceptors.request.use(async (config) => {\r\n  const url = config.url || \"\";\r\n\r\n  // 不對登入或刷新 API 附加 token\r\n  if (url.includes(\"users/login\") || url.includes(\"users/token/refresh\")) {\r\n    return config;\r\n  }\r\n\r\n  let token = getAccessToken();\r\n\r\n  // 主動刷新\r\n  if (isTokenExpiringSoon(token)) {\r\n    try {\r\n      token = await refreshAccessToken();\r\n    } catch (err) {\r\n      clearTokens();\r\n      window.location.href = \"/login\";\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  if (token) {\r\n    config.headers.Authorization = `Bearer ${token}`;\r\n  }\r\n\r\n  return config;\r\n});\r\n\r\n// 被動刷新\r\napi.interceptors.response.use(\r\n  (response) => response,\r\n  async (error) => {\r\n    const originalRequest = error.config;\r\n    const status = error.response?.status;\r\n\r\n    // 若 access token 過期 → 試著 refresh\r\n    if (status === 401 && !originalRequest._retry) {\r\n      originalRequest._retry = true;\r\n      try {\r\n        const newAccess = await refreshAccessToken();\r\n        api.defaults.headers.common[\"Authorization\"] = `Bearer ${newAccess}`;\r\n        originalRequest.headers[\"Authorization\"] = `Bearer ${newAccess}`;\r\n        return api(originalRequest);\r\n      } catch {\r\n        clearTokens();\r\n        window.location.href = \"/login\";\r\n      }\r\n    }\r\n\r\n    return Promise.reject(error);\r\n  }\r\n);\r\n\r\nexport default api;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}